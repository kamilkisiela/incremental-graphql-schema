{"version":3,"sources":["App.tsx","schema-modules-link.ts","apollo.tsx","index.tsx"],"names":["Home","React","lazy","Chats","Calendar","Both","App","useState","page","setPage","onClick","Suspense","fallback","isOperationNode","def","kind","Kind","OPERATION_DEFINITION","onlyUnique","val","i","list","indexOf","client","ApolloClient","cache","InMemoryCache","link","manager","map","schemaBuilder","usedModules","collectRequiredModules","doc","op","definitions","find","selectionSet","selections","field","name","value","str","operation","charAt","toUpperCase","slice","findRootFieldsAndKind","rootFields","operationKind","filter","memoizedSchema","currentHash","loadModules","ids","a","Promise","all","mod","modules","mods","sharedModule","shared","concat","buildSchema","hash","sort","join","toast","schema","typeDefs","concatAST","m","resolvers","execute","document","variableValues","operationName","modulesToLoad","includes","SchemaModulesManager","ApolloLink","fromPromise","query","variables","createSchemaModulesLink","Query","events","chats","Mutation","addEvent","Subscription","makeExecutableSchema","ReactDOM","render","StrictMode","getElementById"],"mappings":"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","file":"static/js/main.fbac9009.chunk.js","sourcesContent":["import React from \"react\";\nimport { ToastContainer } from 'react-toastify';\nimport 'react-toastify/dist/ReactToastify.css';\n\nconst Home = React.lazy(() => import(\"./chunks/home\"));\nconst Chats = React.lazy(() => import(\"./chunks/chats\"));\nconst Calendar = React.lazy(() => import(\"./chunks/calendar\"));\nconst Both = React.lazy(() => import(\"./chunks/chats-and-calendar\"));\n\nfunction App() {\n  const [page, setPage] = React.useState<\n    \"home\" | \"chats\" | \"calendar\" | \"both\"\n  >(\"home\");\n\n  return (\n    <>\n      <div>\n        <button onClick={() => setPage(\"home\")}>Home</button>\n        <button onClick={() => setPage(\"chats\")}>Chats</button>\n        <button onClick={() => setPage(\"calendar\")}>Calendar</button>\n        <button onClick={() => setPage(\"both\")}>\n          Chats and Calendar on one screen\n        </button>\n      </div>\n      <React.Suspense fallback={<div>Loading</div>}>\n        <div>\n          {page === \"chats\" ? (\n            <Chats />\n          ) : page === \"calendar\" ? (\n            <Calendar />\n          ) : page === \"both\" ? (\n            <Both />\n          ) : (\n            <Home />\n          )}\n        </div>\n      </React.Suspense>\n      <ToastContainer />\n    </>\n  );\n}\n\nexport default App;\n","import { toast } from \"react-toastify\";\n\nimport { ApolloLink, fromPromise } from \"apollo-link\";\nimport {\n  OperationDefinitionNode,\n  DefinitionNode,\n  ExecutionArgs,\n  DocumentNode,\n  FieldNode,\n  execute,\n  Kind,\n  ExecutionResult,\n  GraphQLSchema,\n  OperationTypeNode,\n  concatAST,\n} from \"graphql\";\n\ntype OperationType = \"Query\" | \"Mutation\" | \"Subscription\";\n\n/**\n * Represents the exported keywords of a module\n */\ntype SchemaModule = {\n  typeDefs: DocumentNode;\n  resolvers?: {};\n};\n/**\n * A function that loads a module\n */\ntype SchemaModuleLoader = () => Promise<SchemaModule>;\n/**\n * A map between fields of Queries, Mutations or Subscriptions and Schema Modules\n */\nexport type SchemaModuleMap = {\n  modules: SchemaModuleLoader[];\n  sharedModule: SchemaModuleLoader;\n  Query: Record<string, number>;\n  Mutation: Record<string, number>;\n  Subscription: Record<string, number>;\n};\n\nexport type SchemaModuleLinkOptions = {\n  map: SchemaModuleMap;\n  schemaBuilder(input: {\n    typeDefs: DocumentNode;\n    resolvers: any[];\n  }): GraphQLSchema;\n};\n\n/**\n * Creates an ApolloLink that lazy-loads parts of schema, with resolvers and context.\n */\nexport function createSchemaModulesLink({\n  map,\n  schemaBuilder,\n}: SchemaModuleLinkOptions) {\n  const manager = SchemaModulesManager({ map, schemaBuilder });\n\n  return new ApolloLink((op) =>\n    fromPromise(\n      manager.execute({\n        document: op.query,\n        variableValues: op.variables,\n        operationName: op.operationName,\n      })\n    )\n  );\n}\n\n/**\n * Manages Schema Module, orchestrates the lazy-loading, deals with schema building etc\n */\nfunction SchemaModulesManager({ map, schemaBuilder }: SchemaModuleLinkOptions) {\n  let usedModules: number[] = [];\n\n  /**\n   * Collects a list of required modules (based on root-level fields)\n   * and a kind of an operation (Q, M or S)\n   */\n  function collectRequiredModules(doc: DocumentNode): number[] {\n    const [rootFields, operationKind] = findRootFieldsAndKind(doc);\n\n    return rootFields\n      .map((field) => map[operationKind][field])\n      .filter(onlyUnique);\n  }\n\n  /**\n   * Stores the hash of previously built schema\n   */\n  let currentHash: string | null = null;\n  let memoizedSchema: GraphQLSchema | null;\n\n  /**\n   * Loads all requested modules by their id + shared module\n   */\n  async function loadModules(ids: number[]) {\n    const mods = await Promise.all(ids.map((mod) => map.modules[mod]()));\n    const shared = await map.sharedModule();\n\n    return mods.concat([shared]);\n  }\n\n  /**\n   * Builds GraphQLSchema object based on a list of module ids\n   * Does the memoization internally to avoid unnecessary computations\n   */\n  async function buildSchema(ids: number[]) {\n    const hash = ids.slice().sort().join(\"-\");\n\n    if (hash === currentHash) {\n      toast(\"Used memoized schema\");\n      return memoizedSchema!;\n    }\n\n    const modules = await loadModules(ids);\n\n    // saves a list of used modules including those requested by operation\n    usedModules = usedModules.concat(ids).filter(onlyUnique);\n\n    toast(\"Built schema\");\n\n    const schema = schemaBuilder({\n      typeDefs: concatAST(modules.map((m) => m.typeDefs)),\n      resolvers: modules.map((m) => m.resolvers || {}),\n    });\n\n    currentHash = hash;\n    memoizedSchema = schema;\n\n    return schema;\n  }\n\n  return {\n    async execute({\n      document,\n      variableValues,\n      operationName,\n    }: Pick<\n      ExecutionArgs,\n      \"document\" | \"variableValues\" | \"operationName\"\n    >): Promise<ExecutionResult> {\n      const modules = collectRequiredModules(document);\n      const modulesToLoad = modules.filter((mod) => !usedModules.includes(mod));\n\n      return execute({\n        schema: await buildSchema(modulesToLoad.concat(usedModules)),\n        document,\n        variableValues,\n        operationName,\n      });\n    },\n  };\n}\n\nfunction findRootFieldsAndKind(doc: DocumentNode): [string[], OperationType] {\n  const op = doc.definitions.find(isOperationNode)!;\n\n  const rootFields = op.selectionSet.selections.map(\n    (field) => (field as FieldNode).name.value\n  );\n\n  return [rootFields, capitalizeFirst(op.operation)];\n}\n\nfunction isOperationNode(def: DefinitionNode): def is OperationDefinitionNode {\n  return def.kind === Kind.OPERATION_DEFINITION;\n}\n\nfunction capitalizeFirst(str: OperationTypeNode): OperationType {\n  return (str.charAt(0).toUpperCase() + str.slice(1)) as OperationType;\n}\n\nfunction onlyUnique<T>(val: T, i: number, list: T[]) {\n  return list.indexOf(val) === i;\n}\n","import { ApolloClient } from \"apollo-client\";\nimport { InMemoryCache } from \"apollo-cache-inmemory\";\nimport { makeExecutableSchema } from \"@graphql-tools/schema\";\nimport { createSchemaModulesLink } from \"./schema-modules-link\";\n\nexport const client = new ApolloClient({\n  cache: new InMemoryCache(),\n  link: createSchemaModulesLink({\n    // this map is going to be auto-generated\n    map:\n      // no need to write it manually\n      {\n        modules: [\n          () => import(\"./schema/calendar\"),\n          () => import(\"./schema/chats\"),\n        ],\n        sharedModule: () => import(\"./schema/shared\"),\n        Query: {\n          events: 0,\n          chats: 1,\n        },\n        Mutation: {\n          addEvent: 0,\n        },\n        Subscription: {},\n      },\n    schemaBuilder: makeExecutableSchema,\n  }),\n});\n","import React from \"react\";\nimport ReactDOM from \"react-dom\";\nimport { ApolloProvider } from \"react-apollo\";\nimport App from \"./App\";\nimport { client } from \"./apollo\";\n\nReactDOM.render(\n  <React.StrictMode>\n    <ApolloProvider client={client}>\n      <App />\n    </ApolloProvider>\n  </React.StrictMode>,\n  document.getElementById(\"root\")\n);\n"],"sourceRoot":""}